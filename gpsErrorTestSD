/* 
 *  File        : baseGpsErrorTest.ino
 *  Description : A simple Test to determine base GPS Error
 *  Author      : Edgar Gomez 
 */
#include <TinyGPS++.h>
#include <SPI.h>
#include <SD.h>

static const uint32_t GPSBaud = 9600;

double knownLat = 40.7633999333;
double knownLng = -83.8428801166;


// The TinyGPS++ object
TinyGPSPlus gps;


void setup()
{
  Serial.begin(115200);
  Serial1.begin(4800);
  //delay(1000);

  Serial.println("baseGpsErrorTest.ino");
  Serial.println("A simple Test to determine block 1 base GPS Error");
  
  

  // see if the card is present and can be initialized:
  if (!SD.begin(53)) {
    Serial.println("Card failed, or not present");
    // don't do anything more:
    return;
  }
  Serial.println("card initialized.");
}


void loop()
{
  // This sketch displays information every time a new sentence is correctly encoded.
  int count = 0;
  
  while (Serial1.available() != 0 && count < 100)
    if (gps.encode(Serial1.read()))
      writeError();
    count++;
      
}

void writeError()
{

  if(gps.satellites.isValid() && gps.location.isValid()){
    
    double satVal = gps.satellites.value();
    double latErr = knownLat-gps.location.lat();
    double lngErr = knownLng-gps.location.lng();
                    
   File dataFile = SD.open("ErrorLogOne.txt", FILE_WRITE);
                                        
   if (dataFile) {
    dataFile.print(latErr,10);
    dataFile.print(":");
    dataFile.print(lngErr,10);
    dataFile.print(":");
    dataFile.println(satVal);
    dataFile.close();
  }  

  }
}
